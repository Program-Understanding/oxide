
# DRIFT Tutorial

DRIFT is a tool for automated firmware triaging that identifies matched, modified, and unmatched components across firmware versions.

## Getting Started with OXIDE

DRIFT was created as a plugin for oxide, so it depends on oxide's core functionality

### Install and Configure Oxide

1. **Download Oxide**

    ```text
    git clone https://github.com/Program-Understanding/oxide.git
    ```

2. **Set up a new virtual Environment** ***(Recommended)***
    1. Navigate into oxide directory
    2. Create a new virtual environment  
    ```python3 -m venv .venv```
    3. Activate virtual enviroment  
    ```source .venv/bin/activate```

3. **Install Dependancies**  
    DRIFT relies on existing tools to perform it's analysis, including various python packages and [Ghidra](https://github.com/NationalSecurityAgency/ghidra)  

    **Python Packages**  

    ```shell
    pip install flare-capa
    ```  

    ```shell
    pip3 install Termcolor Networkx numpy graphviz pydot matplotlib scipy pyahocorasick opencv-python prettytable tabulate pandas
    ```  

    *pytlsh is required, but sometimes fails to install properly, for easier debugging install it seperately*

    ```shell
    pip3 install pytlsh
    ```

    **Ghidra**  
    1. Install Ghidra's [Latest Release](https://github.com/NationalSecurityAgency/ghidra/releases)

    2. Ensure you have Java JDK 11 or higher installed

    3. Ensure Ghidra works by navigating to ghidra's directory and starting the program with ```./ghidraRun```

   **BinDiff**  
   1. Install [Google BinDiff](https://github.com/google/bindiff) for your platform.  
   2. Ensure the `bindiff` CLI is on your `PATH`:
      ```text
      bindiff --help
      ```
      should work from any shell.  
   3. BinDiff is used to compare `.BinExport` files generated by Ghidra. DRIFT runs:
      ```text
      bindiff --primary <file1.BinExport> --secondary <file2.BinExport> --output_dir <outdir>
      ```
      automatically during analysis.

   **Xvfb (Linux)**  
   If running on a headless server or CI environment, install:
   ```text
   sudo apt-get install xvfb
   ```
   DRIFT wraps headless Ghidra calls with `xvfb-run` to avoid GUI errors.

4. **Initialize Oxide**  
    After all dependancies are installed:  

    navigate to the oxide directory with your virtual
    enviroment active and launch oxide with ```./oxide.sh```  

    The first time you launch oxide, you are given the opportunity to select where to store oxide's configuration file and cache.

    By default, the config file is stored in your user's home directory ```~/.config/oxide/.config.txt```

5. **Add Ghidra to Oxide .config.txt**
    1. Open ```~/.config/oxide/.config.txt``` with your favorite text editor  

    2. navigate to the line "ghidra_path" and add the path to the ***directory*** containing ghidraRun

        *It should look something like this:*
        ```/home/user/ghidra_11.3.1_PUBLIC_20250219/ghidra_11.3.1_PUBLIC```

        Try to avoid having any spaces in your filepath

### Using Oxide

1. **Add files to Oxide's datastore**  
    By default, oxide's datastore is in the following directory:  
    ```/home/(current_user)/.local/share/oxide```

    1. Add your desired set of files to the "datasets" directory.

    2. With oxide running, import your dataset with:  
    ```import path/to/dataset```  

        This imports a "collection" in oxide. Collections can be listed with the command ```show collections```

        You can list the file contents of a collection with  
        ```show &(collection) --verbose```

    3. Test ghidra disasm with a file oid:
    ```run ghidra_disasm %(oid)```

    If these commands don't throw any errors, you have successfully installed and configured oxide with ghidra.

## Running DRIFT

DRIFT is a plugin, so it is used from the Oxide interactive shell.

1. **Download and Install Datasets**  
   Example datasets: [DRIFT-Dataset](https://github.com/Program-Understanding/DRIFT-Dataset)

   - **Dataset I:** OpenWRT (multi-version evolution)
   - **Dataset II:** WAGO PLC (clean vs. backdoored Dropbear)

2. **Load DRIFT**

   ```text
   plugin drift
   ```

3. **Run DRIFT Commands**

### 3 `compare_collections`

Compares two firmware collections and classifies **files** and **functions** as matched, modified, or unmatched.

**Usage:**

```text
compare_collections &target &baseline
compare_collections &target &baseline --view=FILE_CLASSIFICATIONS
compare_collections &target &baseline --view=FUNCTION_CLASSIFICATION
compare_collections &target &baseline --filter=Structurally_Modified
compare_collections &target &baseline --filter=Control_Call_Modified
```

**Views:**
- `FILE_CLASSIFICATIONS` - summary of matched, modified, added, and removed files.
- `FUNCTION_CLASSIFICATION` - counts per function category.

**Filters:**  
DRIFT now includes feature-based filters to refine which functions are flagged as modified:
- `Structurally_Modified`: triggered by control-flow graph structure changes.
- `Control_Call_Modified`: triggered by both structural and call-level changes.

**Examples:**

```text
compare_collections &v2 &v1
compare_collections &v2 &v1 --filter=Structurally_Modified
```

**Output:** Structured dict containing file-level and function-level counts, plus filtered modifications when specified.

---

## Classification and Filtering Details

DRIFT uses Oxideâ€™s binary diffing and semantic analysis features to classify changes:

| Category                | Description                                                   |
|--------------------------|----------------------------------------------------------------|
| `matched`                | Identical functions/files across versions                      |
| `modified`               | Changed functions with similarity < 1.0                         |
| `unmatched_target`       | Added in the target firmware                                   |
| `unmatched_baseline`     | Removed from the baseline firmware                             |
| `Structurally_Modified`  | Modified functions with structural CFG or call changes         |
| `Control_Call_Modified`  | Modified functions with combined structural and call changes   |

Filtering uses feature thresholds on function-level diff metadata:
- Basic Block nodes/edges
- Function calls added/removed
- Control flow structure changes

---

## Example Workflow

```text
plugin drift
compare_collections &23.05.5 &23.05.4 --filter=Structurally_Modified
```

This:
1. Loads DRIFT
2. Compares two versions with structural filtering
3. Runs an entire version series comparison
4. Produces summary CSV and visualization charts.